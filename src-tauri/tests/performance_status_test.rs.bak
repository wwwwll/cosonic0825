//! æ€§èƒ½ç›‘æ§é›†æˆæµ‹è¯•
//! 
//! æµ‹è¯•å†…å®¹ï¼š
//! 1. å¸§ç‡æ§åˆ¶åŠŸèƒ½
//! 2. æ€§èƒ½ç»Ÿè®¡å‡†ç¡®æ€§
//! 3. ä¸è§¦å‘æ¨¡å¼çš„ååŒå·¥ä½œ
//! 4. é«˜è´Ÿè½½åœºæ™¯æ¨¡æ‹Ÿ

#[cfg(test)]
mod tests {
    use crate::camera_ffi::{CameraHandle, CameraPerformance, SystemStats, TriggerMode};
    use std::thread;
    use std::time::Duration;

    /// æµ‹è¯•åŸºæœ¬çš„å¸§ç‡è®¾ç½®åŠŸèƒ½
    #[test]
    fn test_frame_rate_control() {
        println!("ğŸ§ª æµ‹è¯•å¸§ç‡æ§åˆ¶åŠŸèƒ½");
        
        // æµ‹è¯•ä¸åŒå¸§ç‡è®¾ç½®
        let test_fps = vec![1, 5, 10, 15, 20, 30];
        
        for fps in test_fps {
            let mut camera_perf = CameraPerformance::new(0);
            camera_perf.target_fps = fps;
            
            // æ¨¡æ‹Ÿå¸§ç‡æ›´æ–°
            camera_perf.update(fps as f32, 0);
            
            assert_eq!(camera_perf.target_fps, fps);
            assert_eq!(camera_perf.actual_fps, fps as f32);
            assert!(camera_perf.is_healthy());
            
            println!("âœ… {}fps è®¾ç½®æµ‹è¯•é€šè¿‡", fps);
        }
    }

    /// æµ‹è¯•å¸§ç‡å‡†ç¡®æ€§è®¡ç®—
    #[test]
    fn test_fps_accuracy_calculation() {
        println!("ğŸ§ª æµ‹è¯•å¸§ç‡å‡†ç¡®æ€§è®¡ç®—");
        
        let mut camera_perf = CameraPerformance::new(0);
        camera_perf.target_fps = 10;
        
        // æµ‹è¯•ä¸åŒç²¾åº¦çš„å¸§ç‡
        let test_cases = vec![
            (10.0, 100.0), // å®Œå…¨å‡†ç¡®
            (9.9, 99.0),   // è½»å¾®åå·®
            (9.0, 90.0),   // è¾ƒå¤§åå·®
            (5.0, 50.0),   // ä¸¥é‡åå·®
        ];
        
        for (actual_fps, expected_accuracy) in test_cases {
            camera_perf.update(actual_fps, 0);
            let accuracy = camera_perf.get_accuracy_percentage();
            
            assert!((accuracy - expected_accuracy).abs() < 1.0, 
                   "FPS: {}, Expected: {}, Got: {}", actual_fps, expected_accuracy, accuracy);
            
            println!("âœ… FPS {:.1} -> å‡†ç¡®ç‡ {:.1}%", actual_fps, accuracy);
        }
    }

    /// æµ‹è¯•ä¸¢å¸§æ£€æµ‹
    #[test]
    fn test_frame_drop_detection() {
        println!("ğŸ§ª æµ‹è¯•ä¸¢å¸§æ£€æµ‹");
        
        let mut camera_perf = CameraPerformance::new(0);
        camera_perf.target_fps = 10;
        
        // æ¨¡æ‹Ÿä¸¢å¸§æƒ…å†µ
        camera_perf.update(8.5, 15); // å®é™…å¸§ç‡åä½ï¼Œæœ‰ä¸¢å¸§
        
        assert_eq!(camera_perf.frames_dropped, 15);
        assert!(!camera_perf.is_healthy()); // åº”è¯¥ä¸å¥åº·
        assert_eq!(camera_perf.status, "å¸§ç‡åä½");
        
        println!("âœ… ä¸¢å¸§æ£€æµ‹åŠŸèƒ½æ­£å¸¸");
    }

    /// æµ‹è¯•ç³»ç»Ÿæ•´ä½“ç»Ÿè®¡
    #[test]
    fn test_system_stats() {
        println!("ğŸ§ª æµ‹è¯•ç³»ç»Ÿæ•´ä½“ç»Ÿè®¡");
        
        let mut system_stats = SystemStats::new();
        
        // æ¨¡æ‹Ÿæ­£å¸¸è¿è¡ŒçŠ¶æ€
        system_stats.update((10.0, 0), (10.0, 0));
        assert!(system_stats.is_system_healthy());
        assert_eq!(system_stats.system_status, "æ­£å¸¸è¿è¡Œ");
        
        // æ¨¡æ‹Ÿå¼‚å¸¸çŠ¶æ€
        system_stats.update((8.0, 5), (10.0, 0));
        assert!(!system_stats.is_system_healthy());
        assert_eq!(system_stats.system_status, "éƒ¨åˆ†å¼‚å¸¸");
        
        // æ¨¡æ‹Ÿåœæ­¢çŠ¶æ€
        system_stats.update((0.0, 0), (0.0, 0));
        assert!(!system_stats.is_system_healthy());
        assert_eq!(system_stats.system_status, "æœªè¿è¡Œ");
        
        println!("âœ… ç³»ç»Ÿç»Ÿè®¡åŠŸèƒ½æ­£å¸¸");
    }

    /// æµ‹è¯•Display traitå®ç°
    #[test]
    fn test_display_formatting() {
        println!("ğŸ§ª æµ‹è¯•Displayæ ¼å¼åŒ–");
        
        let mut camera_perf = CameraPerformance::new(0);
        camera_perf.target_fps = 10;
        camera_perf.update(9.8, 2);
        
        let display_str = format!("{}", camera_perf);
        assert!(display_str.contains("Camera 0"));
        assert!(display_str.contains("Target: 10fps"));
        assert!(display_str.contains("Actual: 9.80fps"));
        assert!(display_str.contains("Dropped: 2"));
        
        println!("âœ… Displayæ ¼å¼åŒ–: {}", display_str);
    }

    /// æµ‹è¯•åºåˆ—åŒ–åŠŸèƒ½
    #[test]
    fn test_serialization() {
        println!("ğŸ§ª æµ‹è¯•åºåˆ—åŒ–åŠŸèƒ½");
        
        let mut system_stats = SystemStats::new();
        system_stats.update((10.0, 0), (9.5, 1));
        
        // æµ‹è¯•JSONåºåˆ—åŒ–
        let json = serde_json::to_string(&system_stats).unwrap();
        assert!(json.contains("left_camera"));
        assert!(json.contains("right_camera"));
        assert!(json.contains("system_status"));
        
        // æµ‹è¯•ååºåˆ—åŒ–
        let deserialized: SystemStats = serde_json::from_str(&json).unwrap();
        assert_eq!(deserialized.left_camera.actual_fps, 10.0);
        assert_eq!(deserialized.right_camera.frames_dropped, 1);
        
        println!("âœ… JSONåºåˆ—åŒ–/ååºåˆ—åŒ–æ­£å¸¸");
    }

    /// æ¨¡æ‹Ÿé«˜è´Ÿè½½åœºæ™¯æµ‹è¯•
    #[test]
    fn test_high_load_scenario() {
        println!("ğŸ§ª æ¨¡æ‹Ÿé«˜è´Ÿè½½åœºæ™¯æµ‹è¯•");
        
        let mut system_stats = SystemStats::new();
        
        // æ¨¡æ‹Ÿé«˜é¢‘æ›´æ–°
        for i in 0..100 {
            let left_fps = 10.0 + (i as f32 % 10.0) / 10.0; // è½»å¾®æ³¢åŠ¨
            let right_fps = 10.0 - (i as f32 % 5.0) / 10.0;
            let dropped = i % 3; // å¶å°”ä¸¢å¸§
            
            system_stats.update((left_fps, dropped), (right_fps, dropped));
            
            // æ¯10æ¬¡æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
            if i % 10 == 0 {
                assert!(system_stats.timestamp > 0);
                println!("  ç¬¬{}æ¬¡æ›´æ–°: {}", i, system_stats.system_status);
            }
        }
        
        println!("âœ… é«˜è´Ÿè½½åœºæ™¯æµ‹è¯•å®Œæˆ");
    }

    /// è¾¹ç•Œæ¡ä»¶æµ‹è¯•
    #[test]
    fn test_boundary_conditions() {
        println!("ğŸ§ª æµ‹è¯•è¾¹ç•Œæ¡ä»¶");
        
        let mut camera_perf = CameraPerformance::new(0);
        
        // æµ‹è¯•æç«¯å¸§ç‡
        camera_perf.target_fps = 1;
        camera_perf.update(1.0, 0);
        assert!(camera_perf.is_healthy());
        
        camera_perf.target_fps = 30;
        camera_perf.update(30.0, 0);
        assert!(camera_perf.is_healthy());
        
        // æµ‹è¯•é›¶å¸§ç‡
        camera_perf.update(0.0, 0);
        assert!(!camera_perf.is_healthy());
        assert_eq!(camera_perf.status, "æœªè¿è¡Œ");
        
        // æµ‹è¯•å‡†ç¡®ç‡è®¡ç®—è¾¹ç•Œ
        camera_perf.target_fps = 0;
        assert_eq!(camera_perf.get_accuracy_percentage(), 0.0);
        
        println!("âœ… è¾¹ç•Œæ¡ä»¶æµ‹è¯•é€šè¿‡");
    }

    /// é›†æˆæµ‹è¯•ï¼šæ¨¡æ‹Ÿå®Œæ•´å·¥ä½œæµç¨‹
    #[test] 
    fn test_integration_workflow() {
        println!("ğŸ§ª é›†æˆæµ‹è¯•ï¼šå®Œæ•´å·¥ä½œæµç¨‹");
        
        let mut system_stats = SystemStats::new();
        
        // é˜¶æ®µ1ï¼šåˆå§‹åŒ–
        println!("  é˜¶æ®µ1ï¼šç³»ç»Ÿåˆå§‹åŒ–");
        assert_eq!(system_stats.system_status, "åˆå§‹åŒ–ä¸­");
        
        // é˜¶æ®µ2ï¼šé¢„è§ˆæ¨¡å¼ï¼ˆ10fpsï¼‰
        println!("  é˜¶æ®µ2ï¼šé¢„è§ˆæ¨¡å¼ 10fps");
        system_stats.left_camera.target_fps = 10;
        system_stats.right_camera.target_fps = 10;
        system_stats.update((10.0, 0), (10.0, 0));
        assert_eq!(system_stats.system_status, "æ­£å¸¸è¿è¡Œ");
        
        // é˜¶æ®µ3ï¼šæ£€æµ‹æ¨¡å¼ï¼ˆè½¯è§¦å‘ï¼Œå¸§ç‡å¯èƒ½ä¸ç¨³å®šï¼‰
        println!("  é˜¶æ®µ3ï¼šæ£€æµ‹æ¨¡å¼ï¼ˆè½¯è§¦å‘ï¼‰");
        system_stats.update((8.5, 2), (9.0, 1));
        assert_eq!(system_stats.system_status, "éƒ¨åˆ†å¼‚å¸¸");
        
        // é˜¶æ®µ4ï¼šåˆåƒæ¨¡å¼ï¼ˆé«˜ç²¾åº¦åŒæ­¥ï¼‰
        println!("  é˜¶æ®µ4ï¼šåˆåƒæ¨¡å¼ï¼ˆé«˜ç²¾åº¦ï¼‰");
        system_stats.update((10.0, 0), (10.0, 0));
        assert_eq!(system_stats.system_status, "æ­£å¸¸è¿è¡Œ");
        
        println!("âœ… å®Œæ•´å·¥ä½œæµç¨‹é›†æˆæµ‹è¯•é€šè¿‡");
    }
}

// æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆä»…åœ¨benchmark featureä¸‹ç¼–è¯‘ï¼‰
#[cfg(all(test, feature = "benchmark"))]
mod benchmarks {
    use super::*;
    use std::time::Instant;

    #[test]
    fn benchmark_stats_update() {
        let mut system_stats = SystemStats::new();
        let iterations = 10000;
        
        let start = Instant::now();
        for i in 0..iterations {
            system_stats.update((10.0 + i as f32 % 1.0, i % 10), (9.8 + i as f32 % 0.5, i % 5));
        }
        let duration = start.elapsed();
        
        println!("ğŸ“Š æ€§èƒ½åŸºå‡†ï¼š{}æ¬¡æ›´æ–°è€—æ—¶ {:?} (å¹³å‡ {:.2}Î¼s/æ¬¡)", 
                iterations, duration, duration.as_micros() as f64 / iterations as f64);
        
        // ç¡®ä¿æ€§èƒ½åœ¨åˆç†èŒƒå›´å†…ï¼ˆæ¯æ¬¡æ›´æ–°åº”è¯¥å°äº100Î¼sï¼‰
        assert!(duration.as_micros() / iterations < 100);
    }
} 