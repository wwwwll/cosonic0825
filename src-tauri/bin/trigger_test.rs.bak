/**
 * @file trigger_test.rs
 * @brief è§¦å‘æ¨¡å¼æ§åˆ¶å•å…ƒæµ‹è¯•
 * 
 * æµ‹è¯•å†…å®¹ï¼š
 * 1. è½¯è§¦å‘æ¨¡å¼è®¾ç½®
 * 2. 10fpsåŒæ­¥é‡‡é›†æµ‹è¯•
 * 3. è¶…æ—¶å¤„ç†éªŒè¯
 * 
 * cargo build --bin trigger_test
 * cargo run --bin trigger_test
 */

use std::time::{Duration, Instant};
use std::thread;
use merging_image_lib::camera_ffi::{CameraHandle, TriggerMode};

fn main() -> Result<(), Box<dyn std::error::Error>> {
    println!("ğŸš€ è§¦å‘æ¨¡å¼æ§åˆ¶å•å…ƒæµ‹è¯•å¼€å§‹");
    println!("===============================");

    // 1. åˆå§‹åŒ–ç›¸æœº
    println!("ğŸ“· åˆå§‹åŒ–ç›¸æœº...");
    let camera_handle = match CameraHandle::camera_init_ffi() {
        Ok(handle) => {
            println!("âœ… ç›¸æœºåˆå§‹åŒ–æˆåŠŸ");
            handle
        }
        Err(code) => {
            println!("âŒ ç›¸æœºåˆå§‹åŒ–å¤±è´¥ï¼Œé”™è¯¯ç : 0x{:x}", code);
            return Err(format!("ç›¸æœºåˆå§‹åŒ–å¤±è´¥: 0x{:x}", code).into());
        }
    };

    // 2. è®¾ç½®è½¯è§¦å‘æ¨¡å¼
    println!("\nğŸ¯ è®¾ç½®è½¯è§¦å‘æ¨¡å¼...");
    match camera_handle.camera_set_trigger_mode_ffi(TriggerMode::Software) {
        Ok(_) => println!("âœ… è½¯è§¦å‘æ¨¡å¼è®¾ç½®æˆåŠŸ"),
        Err(code) => {
            println!("âŒ è½¯è§¦å‘æ¨¡å¼è®¾ç½®å¤±è´¥ï¼Œé”™è¯¯ç : 0x{:x}", code);
            return Err(format!("è½¯è§¦å‘æ¨¡å¼è®¾ç½®å¤±è´¥: 0x{:x}", code).into());
        }
    }

    // 3. å‡†å¤‡ç¼“å†²åŒº
    let frame_buf_size = CameraHandle::camera_get_frame_buf_size_ffi()
        .map_err(|e| format!("è·å–å¸§ç¼“å†²åŒºå¤§å°å¤±è´¥: 0x{:x}", e))?;
    println!("ğŸ“¦ å¸§ç¼“å†²åŒºå¤§å°: {} bytes", frame_buf_size);

    let mut left_buffer = vec![0u8; frame_buf_size];
    let mut right_buffer = vec![0u8; frame_buf_size];
    
    let mut out_bufs = [
        left_buffer.as_mut_ptr(),
        right_buffer.as_mut_ptr(),
    ];
    let mut out_sizes = [0u32; 2];

    // 4. 10fpsåŒæ­¥é‡‡é›†æµ‹è¯•
    println!("\nâ±ï¸  å¼€å§‹10fpsåŒæ­¥é‡‡é›†æµ‹è¯• (æŒç»­10ç§’)...");
    let test_duration = Duration::from_secs(10);
    let frame_interval = Duration::from_millis(100); // 10fps = 100msé—´éš”
    let start_time = Instant::now();
    
    let mut frame_count = 0;
    let mut success_count = 0;
    let mut timeout_count = 0;
    let mut error_count = 0;

    while start_time.elapsed() < test_duration {
        let frame_start = Instant::now();
        
        // æ‰§è¡Œè½¯è§¦å‘
        match camera_handle.camera_software_trigger_ffi(&mut out_bufs, &mut out_sizes) {
            Ok(_) => {
                success_count += 1;
                let capture_time = frame_start.elapsed();
                println!("ğŸ“¸ å¸§ #{}: å·¦ç›¸æœº={}å­—èŠ‚, å³ç›¸æœº={}å­—èŠ‚, è€—æ—¶={:.2}ms", 
                    frame_count + 1, out_sizes[0], out_sizes[1], 
                    capture_time.as_secs_f32() * 1000.0);
                
                // æ£€æŸ¥è¶…æ—¶è¦æ±‚ (â‰¤ 50ms)
                if capture_time > Duration::from_millis(50) {
                    println!("âš ï¸  è­¦å‘Šï¼šæŠ“å¸§è€—æ—¶è¶…è¿‡50ms: {:.2}ms", capture_time.as_secs_f32() * 1000.0);
                }
            }
            Err(code) => {
                if code == -1001 { // ERR_SOFT_TRIGGER_TIMEOUT
                    timeout_count += 1;
                    println!("â° å¸§ #{}: è½¯è§¦å‘è¶…æ—¶", frame_count + 1);
                } else {
                    error_count += 1;
                    println!("âŒ å¸§ #{}: è½¯è§¦å‘é”™è¯¯ï¼Œé”™è¯¯ç : 0x{:x}", frame_count + 1, code);
                }
            }
        }
        
        frame_count += 1;
        
        // æ§åˆ¶10fpså¸§ç‡ï¼šç­‰å¾…åˆ°ä¸‹ä¸€ä¸ª100msé—´éš”
        let elapsed = frame_start.elapsed();
        if elapsed < frame_interval {
            thread::sleep(frame_interval - elapsed);
        }
    }

    // 5. æµ‹è¯•ç»“æœç»Ÿè®¡
    println!("\nğŸ“Š æµ‹è¯•ç»“æœç»Ÿè®¡");
    println!("===============================");
    println!("æ€»å¸§æ•°: {}", frame_count);
    println!("æˆåŠŸå¸§æ•°: {} ({:.1}%)", success_count, (success_count as f32 / frame_count as f32) * 100.0);
    println!("è¶…æ—¶å¸§æ•°: {} ({:.1}%)", timeout_count, (timeout_count as f32 / frame_count as f32) * 100.0);
    println!("é”™è¯¯å¸§æ•°: {} ({:.1}%)", error_count, (error_count as f32 / frame_count as f32) * 100.0);
    
    let actual_fps = success_count as f32 / test_duration.as_secs_f32();
    println!("å®é™…å¸§ç‡: {:.2} fps", actual_fps);
    
    // 6. éªŒæ”¶æ ‡å‡†æ£€æŸ¥
    println!("\nâœ… éªŒæ”¶æ ‡å‡†æ£€æŸ¥");
    println!("===============================");
    
    let success_rate = (success_count as f32 / frame_count as f32) * 100.0;
    let fps_error = (actual_fps - 10.0).abs();
    
    println!("æˆåŠŸç‡è¦æ±‚: â‰¥90% | å®é™…: {:.1}% | {}", 
        success_rate, if success_rate >= 90.0 { "âœ… é€šè¿‡" } else { "âŒ å¤±è´¥" });
    
    println!("å¸§ç‡ç²¾åº¦è¦æ±‚: 10Â±1fps | å®é™…: {:.2}fps | {}", 
        actual_fps, if fps_error <= 1.0 { "âœ… é€šè¿‡" } else { "âŒ å¤±è´¥" });
    
    println!("è¶…æ—¶è¦æ±‚: â‰¤50ms | {}", 
        if timeout_count == 0 { "âœ… é€šè¿‡" } else { "âš ï¸  æœ‰è¶…æ—¶å‘ç”Ÿ" });

    // 7. æ¸…ç†èµ„æº
    println!("\nğŸ§¹ æ¸…ç†èµ„æº...");
    match camera_handle.camera_release_ffi() {
        Ok(_) => println!("âœ… ç›¸æœºèµ„æºé‡Šæ”¾æˆåŠŸ"),
        Err(code) => println!("âš ï¸  ç›¸æœºèµ„æºé‡Šæ”¾è­¦å‘Š: 0x{:x}", code),
    }

    println!("\nğŸ‰ è§¦å‘æ¨¡å¼æ§åˆ¶å•å…ƒæµ‹è¯•å®Œæˆï¼");
    
    // åˆ¤æ–­æ•´ä½“æµ‹è¯•ç»“æœ
    if success_rate >= 90.0 && fps_error <= 1.0 {
        println!("ğŸŸ¢ æµ‹è¯•ç»“æœ: é€šè¿‡");
        Ok(())
    } else {
        println!("ğŸ”´ æµ‹è¯•ç»“æœ: å¤±è´¥");
        Err("æµ‹è¯•æœªé€šè¿‡éªŒæ”¶æ ‡å‡†".into())
    }
} 