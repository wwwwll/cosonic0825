//! æ ‡å®šå·¥ä½œæµç¨‹ Tauri å‘½ä»¤æ¥å£
//! 
//! ä¸ºå‰ç«¯æä¾›å®Œæ•´çš„æ ‡å®šå·¥ä½œæµç¨‹è°ƒç”¨æ¥å£ï¼ŒåŒ…æ‹¬ï¼š
//! - æ ‡å®šçŠ¶æ€æ£€æµ‹å’Œç®¡ç†
//! - æ ‡å®šå›¾åƒé‡‡é›†å·¥ä½œæµ
//! - æ ‡å®šç®—æ³•æµç¨‹æ§åˆ¶  
//! - æ ‡å®šç»“æœéªŒè¯å’Œä¿å­˜

use std::sync::{Arc, Mutex};
use tauri::State;
use crate::{
    config::SystemConfig,
    modules::calibration_workflow::{
        CalibrationWorkflow, CalibrationStatus, CalibrationFiles, 
        ImagePair, CalibrationProgress, CalibrationResult,
        CalibrationError, UserGuidance, CaptureSession,
    },
};

/// å…¨å±€æ ‡å®šå·¥ä½œæµç¨‹ç®¡ç†å™¨çŠ¶æ€
pub struct CalibrationWorkflowState {
    pub workflow: Arc<Mutex<Option<CalibrationWorkflow>>>,
}

impl CalibrationWorkflowState {
    pub fn new() -> Self {
        Self {
            workflow: Arc::new(Mutex::new(None)),
        }
    }
}

/// åˆå§‹åŒ–æ ‡å®šå·¥ä½œæµç¨‹ç®¡ç†å™¨
#[tauri::command]
pub async fn initialize_calibration_workflow(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<(), String> {
    println!("ğŸ—ï¸ åˆå§‹åŒ–æ ‡å®šå·¥ä½œæµç¨‹ç®¡ç†å™¨...");
    
    // ä½¿ç”¨é»˜è®¤é…ç½®åˆ›å»ºå·¥ä½œæµç¨‹
    let system_config = SystemConfig::new();
    let workflow = CalibrationWorkflow::new(system_config)
        .map_err(|e| format!("åˆå§‹åŒ–æ ‡å®šå·¥ä½œæµç¨‹å¤±è´¥: {}", e))?;
    
    let mut state_guard = state.workflow.lock().unwrap();
    *state_guard = Some(workflow);
    
    println!("âœ… æ ‡å®šå·¥ä½œæµç¨‹ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ");
    Ok(())
}

/// è·å–å½“å‰æ ‡å®šçŠ¶æ€
#[tauri::command]
pub async fn get_calibration_status(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<CalibrationStatus, String> {
    let state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_ref()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    Ok(workflow.get_calibration_status())
}

/// è·å–æ ‡å®šæ–‡ä»¶ä¿¡æ¯
#[tauri::command]
pub async fn get_calibration_files_info(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<CalibrationFiles, String> {
    let state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_ref()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    Ok(workflow.get_calibration_files_info())
}

/// é‡æ–°æ£€æµ‹æ ‡å®šçŠ¶æ€
#[tauri::command]
pub async fn refresh_calibration_status(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<CalibrationStatus, String> {
    let mut state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_mut()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    workflow.detect_calibration_status()
}

/// å¼€å§‹æ ‡å®šå›¾åƒé‡‡é›†ä¼šè¯
#[tauri::command]
pub async fn start_calibration_capture(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<String, String> {
    let mut state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_mut()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    workflow.start_calibration_capture()
}

/// æ‹æ‘„ä¸€ç»„æ ‡å®šå›¾åƒ
/// ç”±äºcamera_manager.rsé‡æ„æµ‹è¯•,æš‚æ—¶è·³è¿‡è¯¥å‡½æ•°
// #[tauri::command]
// pub async fn capture_calibration_image(
//     state: State<'_, CalibrationWorkflowState>,
// ) -> Result<ImagePair, String> {
//     let mut state_guard = state.workflow.lock().unwrap();
//     let workflow = state_guard.as_mut()
//         .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
//     workflow.capture_calibration_image()
// }

/// è·å–å·²é‡‡é›†çš„å›¾åƒåˆ—è¡¨
#[tauri::command]
pub async fn get_captured_images(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<Vec<ImagePair>, String> {
    let state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_ref()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    workflow.get_captured_images()
}

/// åˆ é™¤æŒ‡å®šçš„å›¾åƒå¯¹
#[tauri::command]
pub async fn delete_captured_image(
    state: State<'_, CalibrationWorkflowState>,
    pair_id: u32,
) -> Result<(), String> {
    let mut state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_mut()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    workflow.delete_captured_image(pair_id)
}

/// å®Œæˆå›¾åƒé‡‡é›†ï¼Œæ£€æŸ¥æ˜¯å¦æ»¡è¶³æ ‡å®šè¦æ±‚
#[tauri::command]
pub async fn finish_image_capture(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<bool, String> {
    let mut state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_mut()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    workflow.finish_image_capture()
}

/// å¼€å§‹æ ‡å®šè®¡ç®—æµç¨‹
#[tauri::command]
pub async fn start_calibration_process(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<(), String> {
    let mut state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_mut()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    workflow.start_calibration_process()
}

/// è·å–å½“å‰æ ‡å®šè¿›åº¦
#[tauri::command]
pub async fn get_calibration_progress(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<CalibrationProgress, String> {
    let state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_ref()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    Ok(workflow.get_calibration_progress())
}

/// è·å–æ ‡å®šç»“æœ
#[tauri::command]
pub async fn get_calibration_result(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<Option<CalibrationResult>, String> {
    let state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_ref()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    Ok(workflow.get_calibration_result())
}

/// å–æ¶ˆæ ‡å®šæµç¨‹
#[tauri::command]
pub async fn cancel_calibration(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<(), String> {
    let mut state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_mut()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    workflow.cancel_calibration()
}

/// è·å–æ ‡å®šé”™è¯¯çš„ç”¨æˆ·æŒ‡å¯¼
#[tauri::command]
pub async fn get_calibration_error_guidance(
    state: State<'_, CalibrationWorkflowState>,
    error_type: String,
) -> Result<UserGuidance, String> {
    let state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_ref()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    // è§£æé”™è¯¯ç±»å‹
    let error = match error_type.as_str() {
        "insufficient_images" => CalibrationError::InsufficientImages,
        "feature_detection_failed" => CalibrationError::FeatureDetectionFailed,
        "calibration_failed" => CalibrationError::CalibrationFailed,
        "high_reprojection_error" => CalibrationError::HighReprojectionError,
        "file_system_error" => CalibrationError::FileSystemError,
        "configuration_error" => CalibrationError::ConfigurationError,
        "camera_error" => CalibrationError::CameraError,
        _ => return Err("æœªçŸ¥çš„é”™è¯¯ç±»å‹".to_string()),
    };
    
    Ok(workflow.handle_calibration_error(error))
}

/// è·å–é‡‡é›†ä¼šè¯ä¿¡æ¯
#[tauri::command]
pub async fn get_capture_session_info(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<Option<CaptureSession>, String> {
    let state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_ref()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    // è¿™é‡Œéœ€è¦åœ¨CalibrationWorkflowä¸­æ·»åŠ è·å–ä¼šè¯ä¿¡æ¯çš„æ–¹æ³•
    // æš‚æ—¶è¿”å›None
    Ok(None)
}

/// é‡ç½®æ ‡å®šå·¥ä½œæµç¨‹
#[tauri::command]
pub async fn reset_calibration_workflow(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<(), String> {
    println!("ğŸ”„ é‡ç½®æ ‡å®šå·¥ä½œæµç¨‹...");
    
    let mut state_guard = state.workflow.lock().unwrap();
    
    // é‡æ–°åˆ›å»ºå·¥ä½œæµç¨‹
    let system_config = SystemConfig::new();
    let workflow = CalibrationWorkflow::new(system_config)
        .map_err(|e| format!("é‡ç½®æ ‡å®šå·¥ä½œæµç¨‹å¤±è´¥: {}", e))?;
    
    *state_guard = Some(workflow);
    
    println!("âœ… æ ‡å®šå·¥ä½œæµç¨‹å·²é‡ç½®");
    Ok(())
}

/// å®Œæˆæ•´ä¸ªæ ‡å®šå·¥ä½œæµç¨‹å¹¶é‡Šæ”¾èµ„æº
#[tauri::command]
pub async fn finish_calibration_workflow(
    state: State<'_, CalibrationWorkflowState>,
) -> Result<(), String> {
    let mut state_guard = state.workflow.lock().unwrap();
    let workflow = state_guard.as_mut()
        .ok_or("æ ‡å®šå·¥ä½œæµç¨‹æœªåˆå§‹åŒ–")?;
    
    workflow.finish_calibration_workflow()
} 